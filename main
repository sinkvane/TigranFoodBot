// bot.js
import TelegramBot from "node-telegram-bot-api";
import cron from "node-cron";
import { config } from "./config.js";
import { POINTS, REMINDERS } from "./reports.js";

// ==== Ð›Ð¾Ð³Ð³ÐµÑ€ ====
function log(message) {
  const now = new Date().toISOString();
  console.log(`[${now}] ${message}`);
}

// ==== ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ====
const { TOKEN, ADMIN_CHAT_ID, TIMEZONE } = config;

// ==== Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ ====
const userState = {}; 
// { userId: { step, point, verified, lastReminder, pendingReminders, reminderTimer } }

// ==== Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð¾Ñ‚Ð° ====
const bot = new TelegramBot(TOKEN, { polling: true });
log("Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /start");

// ==== Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€ ====
function getStartKeyboard() {
  return { reply_markup: { keyboard: [[{ text: "/start" }]], resize_keyboard: true, one_time_keyboard: false } };
}

function getEndKeyboard() {
  return { reply_markup: { keyboard: [[{ text: "/end" }]], resize_keyboard: true, one_time_keyboard: false } };
}

// ==== ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /start ====
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;

  const state = userState[chatId];
  if (state && state.verified) {
    bot.sendMessage(chatId, "Ð¡Ð¼ÐµÐ½Ð° ÑƒÐ¶Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ /end.", getEndKeyboard());
    return;
  }

  bot.sendMessage(chatId, "ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ /start, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐ¼ÐµÐ½Ñƒ.", getStartKeyboard());

  // Inline-ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ñ Ñ‚Ð¾Ñ‡ÐºÐ°Ð¼Ð¸
  const inlineButtons = Object.keys(POINTS).map(key => [{ text: key, callback_data: `point:${key}` }]);
  bot.sendMessage(chatId, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ð¾Ñ‡ÐºÑƒ:", { reply_markup: { inline_keyboard: inlineButtons } });

  log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð²Ñ‹Ð·Ð²Ð°Ð» /start`);
});

// ==== ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° /end ====
bot.onText(/\/end/, (msg) => {
  const chatId = msg.chat.id;
  const state = userState[chatId];

  if (!state || !state.verified) {
    bot.sendMessage(chatId, "Ð¡Ð¼ÐµÐ½Ð° Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ /start, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ ÑÐ¼ÐµÐ½Ñƒ.", getStartKeyboard());
    return;
  }

  // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð¾Ð² Ð¸ pending
  if (state.reminderTimer) {
    clearTimeout(state.reminderTimer);
    state.reminderTimer = null;
  }
  state.pendingReminders = [];
  state.verified = false;
  state.step = null;
  state.lastReminder = null;

  bot.sendMessage(chatId, "âœ… Ð¡Ð¼ÐµÐ½Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ /start Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ¼ÐµÐ½Ñ‹.", getStartKeyboard());
  log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð» ÑÐ¼ÐµÐ½Ñƒ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ /end`);
});

// ==== ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° callback_query ====
bot.on("callback_query", (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;

  if (data.startsWith("point:")) {
    const pointName = data.split(":")[1];
    if (!POINTS[pointName]) return;

    userState[chatId] = { step: "enter_password", point: pointName, verified: false, pendingReminders: [], reminderTimer: null };
    bot.sendMessage(chatId, `Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ ${pointName}:`);
    log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð²Ñ‹Ð±Ñ€Ð°Ð» Ñ‚Ð¾Ñ‡ÐºÑƒ "${pointName}" Ñ‡ÐµÑ€ÐµÐ· inline button`);
    bot.answerCallbackQuery(query.id);
    return;
  }

  if (data.startsWith("report:")) {
    const key = data.split(":")[1];
    const reminder = REMINDERS.find(r => r.key === key);
    if (!reminder || !userState[chatId]) {
      bot.answerCallbackQuery(query.id);
      return;
    }

    const state = userState[chatId];
    state.lastReminder = reminder.name;
    state.pendingReminders = state.pendingReminders.filter(r => r !== reminder.name);

    bot.sendMessage(chatId, `Ð’Ñ‹ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚: "${reminder.name}". ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚.`);
    bot.answerCallbackQuery(query.id);
    log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð²Ñ‹Ð±Ñ€Ð°Ð» Ð¾Ñ‚Ñ‡ÐµÑ‚ "${reminder.name}"`);
    return;
  }
});

// ==== ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¸ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹) ====
bot.on("message", (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  if (!userState[chatId]) return;
  const state = userState[chatId];

  // --- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°Ñ€Ð¾Ð»Ñ ---
  if (state.step === "enter_password") {
    if (text === POINTS[state.point].password) {
      state.verified = true;
      state.step = "reports";

      bot.sendMessage(chatId, "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð²ÐµÑ€Ð½Ñ‹Ð¹! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°Ñ….", getEndKeyboard());
      log(`ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ${chatId} Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½ Ð´Ð»Ñ Ñ‚Ð¾Ñ‡ÐºÐ¸ "${state.point}"`);

      scheduleReminders(chatId, state.point);
    } else {
      bot.sendMessage(chatId, "ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·:");
      log(`ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Ñ‚Ð¾Ñ‡ÐºÐ¸ "${state.point}" Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ ${chatId}`);
    }
    return;
  }

  // --- ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° ---
  if (state.verified && (msg.text || msg.photo)) {
    if (!state.lastReminder) return;

    const reminderName = state.lastReminder;
    const reportText = msg.text || msg.caption || "";
    const senderLink = `[${msg.from.username ? '@'+msg.from.username : msg.from.first_name}](tg://user?id=${msg.from.id})`;
    const forwardText = `ðŸ“Œ ÐžÑ‚Ñ‡ÐµÑ‚ "${reminderName}" Ñ Ñ‚Ð¾Ñ‡ÐºÐ¸ ${state.point}\nÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ð»: ${senderLink}\n${reportText}`;

    const sendReport = msg.photo
      ? bot.sendPhoto(ADMIN_CHAT_ID, msg.photo[msg.photo.length - 1].file_id, { caption: forwardText, parse_mode: "Markdown" })
      : bot.sendMessage(ADMIN_CHAT_ID, forwardText, { parse_mode: "Markdown" });

    sendReport.then(() => {
      // ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
      bot.sendMessage(chatId, "âœ… ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½, Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð¸Ð¼!");
      log(`ÐžÑ‚Ñ‡ÐµÑ‚ "${reminderName}" Ð¾Ñ‚ ${msg.from.id} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½`);

      state.lastReminder = null;

      // Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ
      if (state.pendingReminders.length > 0) {
        setTimeout(() => sendPendingReports(chatId), 200);
      }
    }).catch(err => {
      console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð°Ð´Ð¼Ð¸Ð½Ñƒ:", err);
      bot.sendMessage(chatId, "âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.");
    });
  }
});

// ==== Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸Ñ…ÑÑ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð² ====
function sendPendingReports(chatId) {
  const state = userState[chatId];
  if (!state || !state.pendingReminders || state.pendingReminders.length === 0) return;

  const buttons = state.pendingReminders.map(r => {
    const rem = REMINDERS.find(rem => rem.name === r);
    if (!rem) return null;
    return [{ text: r, callback_data: `report:${rem.key}` }];
  }).filter(Boolean);

  if (buttons.length > 0) {
    bot.sendMessage(chatId, "ðŸ”” ÐŸÐ¾ÑÑ‚ÑƒÐ¿Ð¸Ð»Ð¸ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð´Ð¸Ð½ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸:", { reply_markup: { inline_keyboard: buttons } });
    log(`ÐžÑÑ‚Ð°Ð²ÑˆÐ¸ÐµÑÑ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${chatId}: ${state.pendingReminders.join(", ")}`);
  }
}

// ==== ÐŸÐ»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ cron-Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ð¹ ====
function scheduleReminders(chatId, pointName) {
  const tzKey = POINTS[pointName].tz;
  const tz = TIMEZONE[tzKey];

  REMINDERS.forEach(({ name, cron: cronExp }) => {
    cron.schedule(
      cronExp,
      () => {
        const state = userState[chatId];
        if (!state || !state.verified) return;

        if (!state.pendingReminders) state.pendingReminders = [];
        if (!state.pendingReminders.includes(name)) state.pendingReminders.push(name);

        if (!state.reminderTimer) {
          state.reminderTimer = setTimeout(() => {
            sendPendingReports(chatId);
            if (state) {
              state.pendingReminders = [];
              state.reminderTimer = null;
            }
          }, 1000);
        }
      },
      { timezone: tz }
    );
  });
}
